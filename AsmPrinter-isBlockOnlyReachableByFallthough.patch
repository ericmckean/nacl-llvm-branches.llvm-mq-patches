# HG changeset patch
# Parent a2768ebbc09da40e477adc7aab8f88c3308bf944
upstream: reorg isBlockOnlyReachableByFallthough() to have a helper routine

diff -r a2768ebbc09d lib/CodeGen/AsmPrinter/AsmPrinter.cpp
--- a/lib/CodeGen/AsmPrinter/AsmPrinter.cpp	Sun Aug 07 14:59:09 2011 -0700
+++ b/lib/CodeGen/AsmPrinter/AsmPrinter.cpp	Mon Aug 08 12:29:40 2011 -0700
@@ -1955,6 +1955,27 @@
     OutStreamer.EmitSymbolAttribute(Sym, Attr);
 }
 
+// CheckIsMIFallThrough -
+// This is a helper routine for isBlockOnlyReachableByFallthough
+static bool CheckIsMIFallThrough(MachineBasicBlock::iterator II) {
+  MachineInstr &MI = *II;
+  // If it is not a simple branch, we are in a table somewhere.
+  if (!MI.getDesc().isBranch() || MI.getDesc().isIndirectBranch())
+    return false;
+
+  // If we are the operands of one of the branches, this is not
+  // a fall through.
+  for (MachineInstr::mop_iterator OI = MI.operands_begin(),
+         OE = MI.operands_end(); OI != OE; ++OI) {
+    const MachineOperand& OP = *OI;
+    if (OP.isJTI())
+      return false;
+    if (OP.isMBB() && OP.getMBB() == MBB)
+      return false;
+  }
+  return true;
+}
+
 /// isBlockOnlyReachableByFallthough - Return true if the basic block has
 /// exactly one predecessor and the control transfer mechanism between
 /// the predecessor and this block is a fall-through.
@@ -1984,22 +2005,8 @@
   // Check the terminators in the previous blocks
   for (MachineBasicBlock::iterator II = Pred->getFirstTerminator(),
          IE = Pred->end(); II != IE; ++II) {
-    MachineInstr &MI = *II;
-
-    // If it is not a simple branch, we are in a table somewhere.
-    if (!MI.getDesc().isBranch() || MI.getDesc().isIndirectBranch())
+    if (!CheckIsMIFallThrough(II))
       return false;
-
-    // If we are the operands of one of the branches, this is not
-    // a fall through.
-    for (MachineInstr::mop_iterator OI = MI.operands_begin(),
-           OE = MI.operands_end(); OI != OE; ++OI) {
-      const MachineOperand& OP = *OI;
-      if (OP.isJTI())
-        return false;
-      if (OP.isMBB() && OP.getMBB() == MBB)
-        return false;
-    }
   }
 
   return true;
