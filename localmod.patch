# HG changeset patch
# User Jason Kim <jasonwkim@google.com>
# Parent fadc9191903ac8ecee946f6392ae09789ac95c8c
localmod: BundleUnlock

diff -r fadc9191903a lib/CodeGen/AsmPrinter/AsmPrinter.cpp
--- a/lib/CodeGen/AsmPrinter/AsmPrinter.cpp	Fri Aug 12 00:21:00 2011 -0700
+++ b/lib/CodeGen/AsmPrinter/AsmPrinter.cpp	Fri Aug 12 00:30:18 2011 -0700
@@ -2006,8 +2006,17 @@
   // Check the terminators in the previous blocks
   for (MachineBasicBlock::iterator II = Pred->getFirstTerminator(),
          IE = Pred->end(); II != IE; ++II) {
-    if (!CheckIsMIFallThrough(II, MBB))
+    // @LOCALMOD-BEGIN
+    // determine whether the block falls through to the next one.
+    // However, if the last instruction is BUNDLE_UNLOCK, then we have
+    // to look at the one before it instead.
+    MachineBasicBlock::iterator MBBI = II;
+    if ((*MBBI).getOpcode() == TargetOpcode::BUNDLE_UNLOCK) {
+      --MBBI;
+    }
+    if (!CheckIsMIFallThrough(MBBI, MBB))
       return false;
+    // @LOCALMOD-END
   }
 
   return true;
