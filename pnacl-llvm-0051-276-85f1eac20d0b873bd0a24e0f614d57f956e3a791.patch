# HG changeset patch
# User Derek Schuff <dschuff@google.com>
# Date 1310157413 25200
# Branch pnacl-sfi
# Node ID 85f1eac20d0b873bd0a24e0f614d57f956e3a791
# Parent b0aa1ca4555122f290675f38b4a39d12bfd4a056
Add option to LLVM makefile to link with tcmalloc

Review URL: http://codereview.chromium.org/7329023/

 From pnacl-llvm-0051-276-85f1eac20d0b873bd0a24e0f614d57f956e3a791.patch

diff -r b0aa1ca45551 Makefile.rules
--- a/Makefile.rules	Wed Jul 27 14:41:40 2011 -0700
+++ b/Makefile.rules	Wed Jul 27 14:41:41 2011 -0700
@@ -578,7 +578,13 @@
 endif
 
 ifeq ($(NACL_SANDBOX),1)
-  LIBS += -lsrpc -limc_syscalls -lplatform -lgio -lpthread -lm -lnacl 
+  LIBS += -lsrpc -limc_syscalls -lplatform -lgio -lpthread -lm -lnacl
+  ifeq ($(USE_TCMALLOC),1)
+    # Note: -ltcmalloc needs to stay last on the link line
+    LIBS += -ltcmalloc
+    CXX.Flags += -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free
+    C.Flags += -fno-builtin-malloc -fno-builtin-calloc -fno-builtin-realloc -fno-builtin-free
+  endif
 else
   LIBS +=
 endif
