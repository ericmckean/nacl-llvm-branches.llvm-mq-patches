# HG changeset patch
# User David Meyer <pdox@google.com>
# Date 1301681159 25200
# Branch pnacl-sfi
# Node ID eda43d7b2ccbd1ce596ca51be0fb14d9dc686e56
# Parent 98744a8f09c9362b5c533ef2a77c5f3744a1d354
Fix off-by-one error in topological sort adjustment in X86-64 SelectAddr

 From llvm-pnacl-0022-246-eda43d7b2ccbd1ce596ca51be0fb14d9dc686e56.patch

diff -r 98744a8f09c9 lib/Target/X86/X86ISelDAGToDAG.cpp
--- a/lib/Target/X86/X86ISelDAGToDAG.cpp	Thu Mar 31 14:19:20 2011 -0700
+++ b/lib/Target/X86/X86ISelDAGToDAG.cpp	Wed Jul 06 14:08:17 2011 -0700
@@ -1219,10 +1219,11 @@
     if (Index.getValueType() != MVT::i64) {
       Index = CurDAG->getZExtOrTrunc(Index, Index.getDebugLoc(), MVT::i64);
       // Insert the new node into the topological ordering.
-      if (Index->getNodeId() == -1 ||
-          Index->getNodeId() > N.getNode()->getNodeId()) {
-        CurDAG->RepositionNode(N.getNode(), Index.getNode());
-        Index->setNodeId(N.getNode()->getNodeId());
+      if (Parent &&
+          (Index->getNodeId() == -1 ||
+           Index->getNodeId() > Parent->getNodeId())) {
+        CurDAG->RepositionNode(Parent, Index.getNode());
+        Index->setNodeId(Parent->getNodeId());
       }
     }
   }
